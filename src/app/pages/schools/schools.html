<main class="main-content">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">School Renovation Application</h1>
      <p class="page-subtitle">
        Apply for government school renovation under the Tamil Nadu School Infrastructure Development Program.
      </p>
    </div>



    <div class="progress-indicator">
      <div class="progress-step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
        <span>1</span> School Details
      </div>
      <div class="progress-step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
        <span>2</span> Infrastructure Needs
      </div>
      <div class="progress-step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
        <span>3</span> Documentation
      </div>
      <div class="progress-step" [class.active]="currentStep === 4">
        <span>4</span> Review & Submit
      </div>
    </div>

    <form [formGroup]="schoolForm" class="form-container" (ngSubmit)="onSubmit()">
      <div class="form-section card" *ngIf="currentStep === 1" formGroupName="basicInfo">
        <h2 class="section-title">
          <i class="fas fa-info-circle"></i>
          Basic School Information
        </h2>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              Select District <span class="required">*</span>
            </label>
            <select
              class="form-control"
              formControlName="selectedDistrict"
              [class.is-invalid]="schoolForm.get('basicInfo.selectedDistrict')?.invalid && schoolForm.get('basicInfo.selectedDistrict')?.touched">
              <option value="">Choose District</option>
              <option *ngFor="let district of districts" [value]="district">
                {{district}}
              </option>
            </select>
            <div *ngIf="schoolForm.get('basicInfo.selectedDistrict')?.invalid && schoolForm.get('basicInfo.selectedDistrict')?.touched" class="invalid-feedback">
              District selection is required
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              Select Government School <span class="required">*</span>
            </label>
            <select
              class="form-control"
              formControlName="selectedSchoolId"
              [class.is-invalid]="schoolForm.get('basicInfo.selectedSchoolId')?.invalid && schoolForm.get('basicInfo.selectedSchoolId')?.touched">
              <option value="">Choose School</option>
              <option *ngFor="let school of filteredSchools" [value]="school.id">
                {{school.name}} ({{school.udiseCode}})
              </option>
            </select>
            <div *ngIf="schoolForm.get('basicInfo.selectedSchoolId')?.invalid && schoolForm.get('basicInfo.selectedSchoolId')?.touched" class="invalid-feedback">
              School selection is required
            </div>
            <div *ngIf="schoolForm.get('basicInfo.selectedDistrict')?.value && filteredSchools.length === 0" class="alert alert-info mt-2">
              No government schools found in {{schoolForm.get('basicInfo.selectedDistrict')?.value}} district.
            </div>
          </div>
        </div>

        <hr class="form-divider">
        <h3 class="section-subtitle">Auto-populated School Details</h3>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              School Name (English) <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="schoolNameEn" readonly
              [class.is-invalid]="schoolForm.get('basicInfo.schoolNameEn')?.invalid && schoolForm.get('basicInfo.schoolNameEn')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.schoolNameEn')?.invalid && schoolForm.get('basicInfo.schoolNameEn')?.touched" class="invalid-feedback">
              School name in English is required
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              School Name (Tamil) <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="schoolNameTa" readonly
              [class.is-invalid]="schoolForm.get('basicInfo.schoolNameTa')?.invalid && schoolForm.get('basicInfo.schoolNameTa')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.schoolNameTa')?.invalid && schoolForm.get('basicInfo.schoolNameTa')?.touched" class="invalid-feedback">
              School name in Tamil is required
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              UDISE Code <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="udiseCode" readonly
              [class.is-invalid]="schoolForm.get('basicInfo.udiseCode')?.invalid && schoolForm.get('basicInfo.udiseCode')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.udiseCode')?.invalid && schoolForm.get('basicInfo.udiseCode')?.touched" class="invalid-feedback">
              11-digit UDISE code is required
            </div>
            <small class="form-text text-muted">Auto-populated from school selection</small>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              School Type <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="schoolType" readonly
              [class.is-invalid]="schoolForm.get('basicInfo.schoolType')?.invalid && schoolForm.get('basicInfo.schoolType')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.schoolType')?.invalid && schoolForm.get('basicInfo.schoolType')?.touched" class="invalid-feedback">
              School type is required
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              District <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="district" readonly
              [class.is-invalid]="schoolForm.get('basicInfo.district')?.invalid && schoolForm.get('basicInfo.district')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.district')?.invalid && schoolForm.get('basicInfo.district')?.touched" class="invalid-feedback">
              District is required
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              Block/Taluk <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="block" readonly
              [class.is-invalid]="schoolForm.get('basicInfo.block')?.invalid && schoolForm.get('basicInfo.block')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.block')?.invalid && schoolForm.get('basicInfo.block')?.touched" class="invalid-feedback">
              Block/Taluk is required
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            Complete Address <span class="required">*</span>
          </label>
          <textarea class="form-control" formControlName="address" rows="3" readonly
            [class.is-invalid]="schoolForm.get('basicInfo.address')?.invalid && schoolForm.get('basicInfo.address')?.touched"></textarea>
          <div *ngIf="schoolForm.get('basicInfo.address')?.invalid && schoolForm.get('basicInfo.address')?.touched" class="invalid-feedback">
            Address is required
          </div>
        </div>

        <hr class="form-divider">
        <h3 class="section-subtitle">Additional Details</h3>

        <div class="form-row">
          <div class="form-group col-md-4">
            <label class="form-label">
              Pincode <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="pincode"
              [class.is-invalid]="schoolForm.get('basicInfo.pincode')?.invalid && schoolForm.get('basicInfo.pincode')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.pincode')?.invalid && schoolForm.get('basicInfo.pincode')?.touched" class="invalid-feedback">
              6-digit pincode is required
            </div>
          </div>

          <div class="form-group col-md-4">
            <label class="form-label">
              Established Year <span class="required">*</span>
            </label>
            <input type="number" class="form-control" formControlName="establishedYear"
              [class.is-invalid]="schoolForm.get('basicInfo.establishedYear')?.invalid && schoolForm.get('basicInfo.establishedYear')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.establishedYear')?.invalid && schoolForm.get('basicInfo.establishedYear')?.touched" class="invalid-feedback">
              Valid year (1900-{{currentYear}}) is required
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              Current Student Enrollment <span class="required">*</span>
            </label>
            <input type="number" class="form-control" formControlName="studentCount"
              [class.is-invalid]="schoolForm.get('basicInfo.studentCount')?.invalid && schoolForm.get('basicInfo.studentCount')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.studentCount')?.invalid && schoolForm.get('basicInfo.studentCount')?.touched" class="invalid-feedback">
              Student count must be at least 1
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              Number of Teachers <span class="required">*</span>
            </label>
            <input type="number" class="form-control" formControlName="teacherCount"
              [class.is-invalid]="schoolForm.get('basicInfo.teacherCount')?.invalid && schoolForm.get('basicInfo.teacherCount')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.teacherCount')?.invalid && schoolForm.get('basicInfo.teacherCount')?.touched" class="invalid-feedback">
              Teacher count must be at least 1
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-4">
            <label class="form-label">
              Principal Name <span class="required">*</span>
            </label>
            <input type="text" class="form-control" formControlName="principalName"
              [class.is-invalid]="schoolForm.get('basicInfo.principalName')?.invalid && schoolForm.get('basicInfo.principalName')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.principalName')?.invalid && schoolForm.get('basicInfo.principalName')?.touched" class="invalid-feedback">
              Principal name is required
            </div>
          </div>

          <div class="form-group col-md-4">
            <label class="form-label">
              Principal Contact Number <span class="required">*</span>
            </label>
            <input type="tel" class="form-control" formControlName="principalContact"
              [class.is-invalid]="schoolForm.get('basicInfo.principalContact')?.invalid && schoolForm.get('basicInfo.principalContact')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.principalContact')?.invalid && schoolForm.get('basicInfo.principalContact')?.touched" class="invalid-feedback">
              10-digit contact number is required
            </div>
          </div>

          <div class="form-group col-md-4">
            <label class="form-label">
              Principal Email <span class="required">*</span>
            </label>
            <input type="email" class="form-control" formControlName="principalEmail"
              [class.is-invalid]="schoolForm.get('basicInfo.principalEmail')?.invalid && schoolForm.get('basicInfo.principalEmail')?.touched">
            <div *ngIf="schoolForm.get('basicInfo.principalEmail')?.invalid && schoolForm.get('basicInfo.principalEmail')?.touched" class="invalid-feedback">
              Valid email is required
            </div>
          </div>
        </div>
      </div>

      <div class="form-section card" *ngIf="currentStep === 2" formGroupName="infrastructure">
        <h2 class="section-title">
          <i class="fas fa-building"></i>
          Infrastructure Needs Assessment
        </h2>

        <div class="form-group">
          <label class="form-label">
            Areas Requiring Renovation <span class="required">*</span>
          </label>
          <div class="checkbox-grid">
            <div class="form-check" *ngFor="let area of renovationAreas; let i = index">
              <input
                class="form-check-input"
                type="checkbox"
                [id]="area.id"
                [formControl]="getRenovationAreaControl(i)">
              <label class="form-check-label" [for]="area.id">{{area.label}}</label>
            </div>
          </div>
          <div *ngIf="schoolForm.get('infrastructure.renovationAreas')?.invalid && schoolForm.get('infrastructure.renovationAreas')?.touched" class="invalid-feedback d-block">
            At least one area must be selected
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              Priority Level <span class="required">*</span>
            </label>
            <div class="priority-levels">
              <div *ngFor="let level of priorityLevels" class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  [id]="'priority-' + level.value"
                  name="priority"
                  [value]="level.value"
                  formControlName="priority">
                <label class="form-check-label" [for]="'priority-' + level.value">{{level.label}}</label>
              </div>
              <div *ngIf="schoolForm.get('infrastructure.priority')?.invalid && schoolForm.get('infrastructure.priority')?.touched" class="invalid-feedback d-block">
                Priority level is required
              </div>
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              Estimated Budget Range
            </label>
            <select class="form-control" formControlName="budgetRange">
              <option value="">Select Budget Range</option>
              <option *ngFor="let range of budgetRanges" [value]="range.value">{{range.label}}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            Current Condition of Infrastructure <span class="required">*</span>
          </label>
          <textarea class="form-control" formControlName="currentCondition" rows="4"
            [class.is-invalid]="schoolForm.get('infrastructure.currentCondition')?.invalid && schoolForm.get('infrastructure.currentCondition')?.touched"></textarea>
          <div *ngIf="schoolForm.get('infrastructure.currentCondition')?.invalid && schoolForm.get('infrastructure.currentCondition')?.touched" class="invalid-feedback">
            Current condition description is required
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            Expected Outcome After Renovation
          </label>
          <textarea class="form-control" formControlName="expectedOutcome" rows="4"></textarea>
        </div>
      </div>

      <div class="form-section card" *ngIf="currentStep === 3" formGroupName="documentation">
        <h2 class="section-title">
          <i class="fas fa-file-alt"></i>
          Required Documentation
        </h2>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              School Recognition Certificate <span class="required">*</span>
            </label>
            <div class="custom-file">
              <input
                type="file"
                class="custom-file-input"
                id="recognitionCert"
                (change)="onFileChange($event, 'recognitionCert', 'documentation')"
                required>
              <label class="custom-file-label" for="recognitionCert">
                {{ schoolForm.get('documentation.recognitionCert')?.value?.name || 'Choose file' }}
              </label>
            </div>
            <div *ngIf="schoolForm.get('documentation.recognitionCert')?.invalid && schoolForm.get('documentation.recognitionCert')?.touched" class="invalid-feedback d-block">
              Recognition certificate is required
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              Previous Assessment Report (if any)
            </label>
            <div class="custom-file">
              <input
                type="file"
                class="custom-file-input"
                id="assessmentReport"
                (change)="onFileChange($event, 'assessmentReport', 'documentation')">
              <label class="custom-file-label" for="assessmentReport">
                {{ schoolForm.get('documentation.assessmentReport')?.value?.name || 'Choose file' }}
              </label>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="form-label">
              Current Condition Photos <span class="required">*</span>
            </label>
            <div class="custom-file">
              <input
                type="file"
                class="custom-file-input"
                id="conditionPhotos"
                (change)="onFileChange($event, 'conditionPhotos', 'documentation')"
                required multiple> <label class="custom-file-label" for="conditionPhotos">
                {{ schoolForm.get('documentation.conditionPhotos')?.value?.name || 'Choose file(s)' }}
              </label>
            </div>
            <div *ngIf="schoolForm.get('documentation.conditionPhotos')?.invalid && schoolForm.get('documentation.conditionPhotos')?.touched" class="invalid-feedback d-block">
              At least one condition photo is required
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="form-label">
              Detailed Budget Estimates (if available)
            </label>
            <div class="custom-file">
              <input
                type="file"
                class="custom-file-input"
                id="budgetEstimates"
                (change)="onFileChange($event, 'budgetEstimates', 'documentation')">
              <label class="custom-file-label" for="budgetEstimates">
                {{ schoolForm.get('documentation.budgetEstimates')?.value?.name || 'Choose file' }}
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section card" *ngIf="currentStep === 4">
        <h2 class="section-title">
          <i class="fas fa-check-circle"></i>
          Review Your Application
        </h2>

        <div class="review-summary">
          <h3 class="review-header">Basic School Information</h3>
          <div class="review-section-content">
            <div class="review-item">
              <strong>Selected District:</strong> {{ schoolForm.get('basicInfo.selectedDistrict')?.value }}
            </div>
            <div class="review-item">
              <strong>Selected School:</strong> {{ schoolForm.get('basicInfo.schoolNameEn')?.value }} ({{ schoolForm.get('basicInfo.udiseCode')?.value }})
            </div>
            <div class="review-item">
              <strong>School Name (Tamil):</strong> {{ schoolForm.get('basicInfo.schoolNameTa')?.value }}
            </div>
            <div class="review-item">
              <strong>School Type:</strong> {{ schoolForm.get('basicInfo.schoolType')?.value | titlecase }} School
            </div>
            <div class="review-item">
              <strong>District (Auto):</strong> {{ schoolForm.get('basicInfo.district')?.value }}
            </div>
            <div class="review-item">
              <strong>Block/Taluk (Auto):</strong> {{ schoolForm.get('basicInfo.block')?.value }}
            </div>
            <div class="review-item">
              <strong>Address:</strong> {{ schoolForm.get('basicInfo.address')?.value }}
            </div>
            <div class="review-item">
              <strong>Pincode:</strong> {{ schoolForm.get('basicInfo.pincode')?.value }}
            </div>
            <div class="review-item">
              <strong>Established Year:</strong> {{ schoolForm.get('basicInfo.establishedYear')?.value }}
            </div>
            <div class="review-item">
              <strong>Student Enrollment:</strong> {{ schoolForm.get('basicInfo.studentCount')?.value }}
            </div>
            <div class="review-item">
              <strong>Number of Teachers:</strong> {{ schoolForm.get('basicInfo.teacherCount')?.value }}
            </div>
            <div class="review-item">
              <strong>Principal Name:</strong> {{ schoolForm.get('basicInfo.principalName')?.value }}
            </div>
            <div class="review-item">
              <strong>Principal Contact:</strong> {{ schoolForm.get('basicInfo.principalContact')?.value }}
            </div>
            <div class="review-item">
              <strong>Principal Email:</strong> {{ schoolForm.get('basicInfo.principalEmail')?.value }}
            </div>
          </div>

          <h3 class="review-header mt-4">Infrastructure Needs</h3>
          <div class="review-section-content">
            <div class="review-item">
              <strong>Areas for Renovation:</strong> {{ getSelectedRenovationAreas().join(', ') || 'None selected' }}
            </div>
               <div class="review-item">
              <strong>Priority Level:</strong> {{ (schoolForm.get('infrastructure.priority')?.value || 'Not specified') | titlecase }}
            </div>
            <div class="review-item">
              <strong>Budget Range:</strong> {{ getBudgetRangeLabel(schoolForm.get('infrastructure.budgetRange')?.value) }}
            </div>
            <div class="review-item">
              <strong>Current Condition:</strong> {{ schoolForm.get('infrastructure.currentCondition')?.value || 'Not provided' }}
            </div>
            <div class="review-item">
              <strong>Expected Outcome:</strong> {{ schoolForm.get('infrastructure.expectedOutcome')?.value || 'Not provided' }}
            </div>
          </div>

          <h3 class="review-header mt-4">Documentation</h3>
          <div class="review-section-content">
            <div class="review-item">
              <strong>Recognition Certificate:</strong> {{ schoolForm.get('documentation.recognitionCert')?.value?.name || 'Not uploaded' }}
            </div>
            <div class="review-item">
              <strong>Assessment Report:</strong> {{ schoolForm.get('documentation.assessmentReport')?.value?.name || 'Not uploaded' }}
            </div>
            <div class="review-item">
              <strong>Condition Photos:</strong> {{ schoolForm.get('documentation.conditionPhotos')?.value?.name || 'Not uploaded' }}
            </div>
            <div class="review-item">
              <strong>Budget Estimates:</strong> {{ schoolForm.get('documentation.budgetEstimates')?.value?.name || 'Not uploaded' }}
            </div>
          </div>
        </div>
      </div>

      <div class="form-navigation">
        <button type="button" class="btn btn-outline-primary" (click)="prevStep()" [disabled]="currentStep === 1">
          <i class="fas fa-arrow-left"></i> Previous
        </button>

        <button *ngIf="currentStep < 4" type="button" class="btn btn-primary" (click)="nextStep()">
          Next <i class="fas fa-arrow-right"></i>
        </button>

        <button *ngIf="currentStep === 4" type="submit" class="btn btn-success" [disabled]="!schoolForm.valid">
          <i class="fas fa-check"></i> Submit Application
        </button>
      </div>
    </form>
  </div>
</main>

<footer class="footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-logo">
        <div class="logo-wrapper">
          <img src="assets/images/govt_logo.jpeg" alt="Government of Tamil Nadu Logo" class="govt-logo">
        </div>
        <div class="footer-logo-text"> <h3>{{ currentLanguage === 'english' ? 'Tamil Nadu School Renovation Initiative' : 'தமிழ்நாடு பள்ளி புதுப்பித்தல் முயற்சி' }}</h3>
          <p>{{ currentLanguage === 'english' ? 'Building better futures through education' : 'கல்வி மூலம் சிறந்த எதிர்காலத்தை உருவாக்குதல்' }}</p>
        </div>
      </div>
      <div class="footer-links">
        <h4>{{ currentLanguage === 'english' ? 'Quick Links' : 'விரைவு இணைப்புகள்' }}</h4>
        <ul>
          <li><a routerLink="/">{{ currentLanguage === 'english' ? 'Home' : 'முகப்பு' }}</a></li>
          <li><a routerLink="/schools">{{ currentLanguage === 'english' ? 'Schools' : 'பள்ளிகள்' }}</a></li>
          <li><a routerLink="/donate">{{ currentLanguage === 'english' ? 'Donate' : 'நன்கொடை' }}</a></li>
          <li><a routerLink="volunteer">{{ currentLanguage === 'english' ? 'Volunteer' : 'தன்னார்வலர்' }}</a></li>
        </ul>
      </div>
      <div class="footer-contact">
        <h4>{{ currentLanguage === 'english' ? 'Contact Us' : 'எங்களைத் தொடர்பு கொள்ள' }}</h4>
        <p>infotnschools.com</p>
        <p>+91 9876543210</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; {{ currentYear }} {{ currentLanguage === 'english' ? 'Tamil Nadu School Renovation Initiative. All rights reserved.' : 'தமிழ்நாடு பள்ளி புதுப்பித்தல் முயற்சி. அனைத்து உரிமைகளும் பாதுகாக்கப்பட்டவை.' }}</p>
    </div>
  </div>
</footer>